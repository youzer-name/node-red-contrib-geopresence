<script type="text/javascript">
    RED.nodes.registerType('geopresence', {
        category: 'function',
        color: '#a6bbcf',
        defaults: {
            name: { value: "geopresence" },
            location: { value: "" },
            locationLat: { value: 0, validate: RED.validators.number() },
            locationLon: { value: 0, validate: RED.validators.number() },
            checkLat: { value: "lat" },
            checkLatType: { value: "msg" },
            checkLon: { value: "lon" },
            checkLonType: { value: "msg" },
            presentMsg: { value: "true" },
            presentMsgType: { value: "bool" },
            notPresentMsg: { value: "false" },
            notPresentMsgType: { value: "bool" },
            distance: { value: 1, validate: RED.validators.number() },
            onlySendOnChange: { value: false }
        },
        inputs: 1,
        outputs: 1,
        icon: "font-awesome/fa-map-marker",
        label: function () {
            return this.name || "geopresence";
        },

        oneditprepare: function () {
            $("#node-input-checkLat").typedInput({
                default: 'msg',
                types: ['msg', 'flow', 'global'],
                typeField: $("#node-input-checkLat-type")
            }).typedInput("type", this.checkLatType || "msg")
              .typedInput("value", this.checkLat || "");

            $("#node-input-checkLon").typedInput({
                default: 'msg',
                types: ['msg', 'flow', 'global'],
                typeField: $("#node-input-checkLon-type")
            }).typedInput("type", this.checkLonType || "msg")
              .typedInput("value", this.checkLon || "");

            $("#node-input-presentMsg").typedInput({
                default: 'str',
                types: ['str', 'bool'],
                typeField: $("#node-input-presentMsg-type")
            }).typedInput("type", this.presentMsgType || "bool")
              .typedInput("value", this.presentMsg || "");

            $("#node-input-notPresentMsg").typedInput({
                default: 'str',
                types: ['str', 'bool'],
                typeField: $("#node-input-notPresentMsg-type")
            }).typedInput("type", this.notPresentMsgType || "bool")
              .typedInput("value", this.notPresentMsg || "");

            $("#node-input-onlySendOnChange").prop("checked", this.onlySendOnChange);

        },

        oneditsave: function () {
            this.checkLat = $("#node-input-checkLat").typedInput("value");
            this.checkLatType = $("#node-input-checkLat").typedInput("type");

            this.checkLon = $("#node-input-checkLon").typedInput("value");
            this.checkLonType = $("#node-input-checkLon").typedInput("type");

            this.presentMsg = $("#node-input-presentMsg").typedInput("value");
            this.presentMsgType = $("#node-input-presentMsg").typedInput("type");

            this.notPresentMsg = $("#node-input-notPresentMsg").typedInput("value");
            this.notPresentMsgType = $("#node-input-notPresentMsg").typedInput("type");

            this.onlySendOnChange = $("#node-input-onlySendOnChange").prop("checked");
        }
    });
</script>

<script type="text/html" data-template-name="geopresence">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="geopresence">
    </div>
    <div class="form-row">
        <label for="node-input-location"><i class="fa fa-map-marker"></i> Location</label>
        <input type="text" id="node-input-location" placeholder="e.g., Home, Office">
    </div>
    <div class="form-row">
        <label for="node-input-locationLat">Location Lat</label>
        <input type="number" step="any" id="node-input-locationLat">
    </div>
    <div class="form-row">
        <label for="node-input-locationLon">Location Lon</label>
        <input type="number" step="any" id="node-input-locationLon">
    </div>
    <div class="form-row">
        <label for="node-input-checkLat">Check Lat</label>
        <input type="text" id="node-input-checkLat">
        <input type="hidden" id="node-input-checkLat-type">
    </div>
    <div class="form-row">
        <label for="node-input-checkLon">Check Lon</label>
        <input type="text" id="node-input-checkLon">
        <input type="hidden" id="node-input-checkLon-type">
    </div>
    <div class="form-row">
        <label for="node-input-distance">Distance (km)</label>
        <input type="number" step="any" id="node-input-distance">
    </div>
    <div class="form-row">
        <label for="node-input-presentMsg">Present Message</label>
        <input type="text" id="node-input-presentMsg">
        <input type="hidden" id="node-input-presentMsg-type">
    </div>
    <div class="form-row">
        <label for="node-input-notPresentMsg">Not Present Message</label>
        <input type="text" id="node-input-notPresentMsg">
        <input type="hidden" id="node-input-notPresentMsg-type">
    </div>
    <div class="form-row">
        <label for="node-input-onlySendOnChange">
            <input type="checkbox" id="node-input-onlySendOnChange" style="display:inline-block; width:auto; vertical-align:top;">
            Only send when presence changes
        </label>
    </div>
</script>

<script type="text/html" data-help-name="geopresence">
    <p>
        The <strong>GeoPresence</strong> node determines whether a given set of coordinates (latitude and longitude)
        are within a specified distance (in kilometers) of a fixed location.
    </p>
    <h3>Inputs</h3>
    <ul>
        <li><strong>msg</strong>: The incoming message. Coordinates to check can be pulled from <code>msg</code>, <code>flow</code>, or <code>global</code> context.</li>
    </ul>
    <h3>Outputs</h3>
    <ul>
        <li>If the coordinates are within the specified distance, the output <code>msg.payload</code> will include:
            <ul>
                <li><code>name</code>: The name of the location</li>
                <li><code>presence</code>: The "Present Message" value</li>
            </ul>
        </li>
        <li>If not within range, <code>presence</code> will be set to the "Not Present Message" value.</li>
        <li>All other properties from the original message are preserved.</li>
    </ul>
</script>
